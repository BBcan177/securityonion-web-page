#!/bin/sh

set -e

case "$1" in
    configure)

	# Make modifications to the target of the ssl.conf symlink (/etc/apache2/mods-available/ssl.conf)
	FILE="/etc/apache2/mods-available/ssl.conf"
	if [ -f $FILE ]; then
		if grep "^SSLProtocol all -SSLv2$" $FILE >/dev/null 2>&1; then
			if sed -i 's|SSLProtocol all -SSLv2|SSLProtocol all -SSLv2 -SSLv3|g' $FILE; then 
				echo "* Apache config has been updated to disable SSLv3."
				echo "* Please restart Apache using the following command:"
				echo "  sudo service apache2 restart"
			else
				echo "* Error updating $FILE to disable SSLv3."
				echo "* Please disable SSLv3 manually."
			fi
		fi
	fi

	# Add ELSA local queries if not already present
	FILE="/var/www/so/elsa/local.php"
	if [ -f $FILE ]; then
		echo "* $FILE already exists, not overwriting."
	else
		echo "* $FILE doesn't already exist."
		echo "* Copying $FILE.empty to $FILE."
		cp $FILE.empty $FILE || echo "Error copying $FILE.empty to $FILE."
	fi

	# Copy default Apache site to new site called securityonion
	FILE="/etc/apache2/sites-available/securityonion.conf"
	cp /etc/apache2/sites-available/default-ssl.conf $FILE || echo "Unable to create $FILE."

	# Update DocumentRoot to /var/www/so
	sed -i 's|DocumentRoot /var/www/html|DocumentRoot /var/www/so|g' $FILE || echo "Error updating DocumentRoot in $FILE."

	# Enable new securityonion site
	a2ensite securityonion || echo "Error enabling Apache2 site $FILE."

	# Restart Apache2
	service apache2 restart || echo "Error restarting Apache2."

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;


    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
